# VirusTotal Cowrie Malware Enrichment
This python script is provided by Jesse La Grew[1]<br>

This script reside on each (if you have multiple) DShield sensors that runs a cronjob daily against the cowrie.json logs to query VirusTotal SHA256 hashes and save the result.<br>
This script is used query the cowrie log hashes against the Virustotal data. To get a copy of the scrip:<br>

## Login in the DShield Sensor
````
sudo mkdir /srv/hash
mkdir $HOME/scripts
cd /srv/hash
sudo wget https://raw.githubusercontent.com/jslagrew/cowrieprocessor/main/cowrie_malware_enrichment.py
````

Change the location of the script (/home/guy) and add the following to the crontab
````
sudo crontab -e
````
Add This to the crontab and update the location of the script<br>
````
# Query cowrie hash logs for the previous day
0 1 * * * /home/guy/scripts/cowrie_vt.sh > /dev/null 2>1&
````
Insert your own VirusTotal Key<br>
````
vi $HOME/scripts/cowrie_vt.sh
````
/usr/bin/python3 ./cowrie_malware_enrichment.py --vtapi "insert here your own VT API key" --filepath $FILE

### Testing Script Output
After cowrie_malware_enrichment.py and cowrie_vt.sh have been downloaded, run this manual test to ensure it is working and parsing the logs against VirusTotal.<br>
````
sudo bash -x $HOME/scripts/cowrie_vt.sh
````
The output should show the logs being parsed against cowrie.json logs.<br>
The resulting file should be in /srv/hash. The file parsed by filebeat is: **vt_data**<br>

### Manually Processing a JSON File
Decide which date you need to process or reprocess because something failed using the following steps:<br>
````
cd /srv/hash<br>
sudo python3 ./cowrie_malware_enrichment.py --vtapi "insert here your own VT API key" --filepath "/srv/cowrie/var/log/cowrie/cowrie.json.2024-07-10"
````
### vt_data Ouptut Example
To view the data, use the following command:<br>
$ sudo cat /srv/hash/vt_data | jq |more<br>
<pre>
{
  "hash": "a8460f446be540410004b1a8db4083773fa46f7fe76fa84219c93daa1669f8f2",
  "malicious": 24,
  "suspicious": 0,
  "undetected": 40,
  "harmless": 0,
  "timeout": 0,
  "confirmed-timeout": 0,
  "failure": 0,
  "type-unsupported": 14,
  "last_analysis_date": 1720638005,
  "filetype": "file seems to be plain text/ASCII",
  "typetag": "text",
  "description": "Text",
  "filename": "20240710-190004-0bec64ef5db4-1-redir__home_admin__ssh_authorized_keys",
  "classification": "trojan.shell/malkey"
}
</pre>

# DShield SIEM Dashboard Display of Hashes
![image](https://github.com/bruneaug/DShield-SIEM/assets/48228401/d1f726a3-33c3-4ce5-8975-ecb284c96fc6)

[1] https://github.com/jslagrew/cowrieprocessor
